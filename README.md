# uwb_trilateration

UWBタグから送信される距離データを **UDPで受信**し、  
**三点測位（Trilateration）によってリアルタイムに2次元位置を推定・可視化**するPythonスクリプトです。

Matplotlib を用いて、  
- 現在位置  
- 移動軌跡  
- 各アンカーとの距離  

をリアルタイムに表示します。

---

## 概要

- UWBアンカー3台からの距離データをUDPで受信
- epoch（同期番号）単位で **3台分そろった場合のみ位置計算**
- 三点測位（Tr2D）によりタグ位置を算出
- Matplotlib + FuncAnimation によるリアルタイム描画
- 軌跡表示（約1分間分を保持）

---

## 特徴

- **epoch管理付きUDP受信**
  - 異なるepochが混在しても誤計算しない
  - 200ms以内に3台分そろわない場合は破棄
- マルチスレッド構成
  - UDP受信と描画を分離
- 軌跡は `deque` により軽量に管理
- 実験・デバッグ用途に適したシンプル構成

---

## 動作環境

- Python 3.9 以上（推奨）
- OS
  - Windows
  - macOS
  - Linux

---

## 依存ライブラリ

```bash
pip install matplotlib
````

※ `socket`, `threading`, `struct` などは標準ライブラリです。

---

## ディレクトリ構成（例）

```
.
├── uwb_realtime_plot.py
├── Tr2D.py
└── README.md
```

---

## 使用方法

```bash
python uwb_realtime_plot.py
```

起動すると、UDPポート `9999` で受信待ち状態になります。

---

## UDP パケット仕様

```text
PACK_FMT = "!IfI"
```

| フィールド     | 型      | 説明          |
| --------- | ------ | ----------- |
| client_id | uint32 | アンカーID（1〜3） |
| distance  | float  | タグとの距離 [cm] |
| epoch     | uint32 | 同期用エポック番号   |

### 注意

* **同一epochで3台分そろった場合のみ位置計算**を行います
* epochが異なるデータは混在しても無視されます

---

## アンカー配置

スクリプト冒頭でアンカー座標を指定しています（単位：cm）

```python
uwb = Tr2D.Tr2D(((450, 0), (0, 0), (0, 450)))
```

```
A2 (0,450)
│
│
│
A1 (0,0) ───────── A3 (450,0)
```

※ 配置に応じて自由に変更してください。

---

## 表示内容

* ▲：アンカー位置
* ●：現在のタグ位置
* ―：タグの移動軌跡
* 左上テキスト：各アンカーとの距離（cm）

---

## 更新周期

```python
FuncAnimation(fig, update, interval=100)
```

* 描画更新：100ms周期
* UDP送信周期に合わせて調整可能

---

## よくある注意点

* 3台分の距離が同一epochで届かないと位置は更新されません
* solve_once() が失敗した場合は自動的にスキップされます
* UWB距離誤差が大きいと解が不安定になります

---

## 今後の拡張アイデア

* 測位成功／失敗の可視化
* epochドロップ率の表示
* CSVログ保存
* アンカー数拡張（N点測位）
* 誤差楕円や信頼度の描画

---


## 備考

本スクリプトは **UWB測位アルゴリズムの検証・可視化用途**を主目的としています。
リアルタイム性よりも「データの整合性」を重視した実装になっています。
